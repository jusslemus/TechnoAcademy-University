<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestionar Usuarios - Admin</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <nav class="navbar">
    <div class="nav-container">
      <h1>üéì TechnoAcademy - Admin</h1>
      <ul class="nav-menu">
        <li><a href="/admin/dashboard">Dashboard</a></li>
        <li><a href="/admin/usuarios">Usuarios</a></li>
        <li><a href="/admin/carreras">Carreras</a></li>
        <li><a href="/admin/materias">Materias</a></li>
        <li><a href="/admin/periodos">Per√≠odos</a></li>
        <li><a href="/logout">Cerrar Sesi√≥n</a></li>
      </ul>
    </div>
  </nav>

  <div class="container">
    <!-- Mensaje de notificaci√≥n -->
    <div id="notification" class="notification" style="display: none;"></div>

    <h2>üë• Gestionar Usuarios</h2>

    <!-- Barra de b√∫squeda -->
    <div class="search-section">
      <input type="text" id="searchInput" placeholder="üîç Buscar por usuario o tipo..." 
             class="search-input">
    </div>

    <div class="form-section">
      <h3>‚ûï Crear Nuevo Usuario</h3>
      <form id="userForm">
        <div class="form-group">
          <label for="nombre_usuario">Usuario: *</label>
          <input type="text" id="nombre_usuario" name="nombre_usuario" required 
                 placeholder="Ej: alumno2025" minlength="4">
          <small>M√≠nimo 4 caracteres</small>
        </div>

        <div class="form-group">
          <label for="contrasena">Contrase√±a: *</label>
          <input type="password" id="contrasena" name="contrasena" required 
                 placeholder="M√≠nimo 6 caracteres" minlength="6">
          <small>M√≠nimo 6 caracteres</small>
        </div>

        <div class="form-group">
          <label for="confirmar_contrasena">Confirmar Contrase√±a: *</label>
          <input type="password" id="confirmar_contrasena" name="confirmar_contrasena" required 
                 placeholder="Repita la contrase√±a">
        </div>

        <div class="form-group">
          <label for="tipo_usuario">Tipo de Usuario: *</label>
          <select id="tipo_usuario" name="tipo_usuario" required>
            <option value="">-- Seleccione --</option>
            <option value="ALUMNO">Alumno</option>
            <option value="ADMIN">Administrador</option>
          </select>
        </div>

        <div class="form-actions">
          <button type="submit" class="btn btn-primary">
            <span id="btn-crear-text">‚úÖ Crear Usuario</span>
            <span id="btn-crear-loader" style="display: none;">Creando...</span>
          </button>
          <button type="reset" class="btn btn-secondary">üîÑ Limpiar</button>
        </div>
      </form>
    </div>

    <hr>

    <div class="table-section">
      <h3>üìã Usuarios del Sistema</h3>
      <div class="table-responsive">
        <table class="table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Usuario</th>
              <th>Tipo</th>
              <th>Estado</th>
              <th>Fecha Creaci√≥n</th>
              <th>√öltimo Acceso</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="usuariosTable">
            <tr>
              <td colspan="7" style="text-align: center;">
                <div class="loader">Cargando usuarios...</div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Modal para editar usuario -->
  <div id="editModal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3>‚úèÔ∏è Editar Usuario</h3>
        <span class="close-modal" onclick="cerrarModal()">&times;</span>
      </div>
      <form id="editForm">
        <input type="hidden" id="edit_id_usuario">
        
        <div class="form-group">
          <label for="edit_nombre_usuario">Nombre de Usuario:</label>
          <input type="text" id="edit_nombre_usuario" required minlength="4">
        </div>

        <div class="form-group">
          <label for="edit_tipo_usuario">Tipo de Usuario:</label>
          <select id="edit_tipo_usuario" required>
            <option value="ALUMNO">Alumno</option>
            <option value="ADMIN">Administrador</option>
          </select>
        </div>

        <div class="form-group">
          <label>
            <input type="checkbox" id="cambiar_contrasena">
            Cambiar contrase√±a
          </label>
        </div>

        <div id="password-fields" style="display: none;">
          <div class="form-group">
            <label for="edit_nueva_contrasena">Nueva Contrase√±a:</label>
            <input type="password" id="edit_nueva_contrasena" minlength="6">
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="cerrarModal()">Cancelar</button>
          <button type="submit" class="btn btn-primary">Guardar Cambios</button>
        </div>
      </form>
    </div>
  </div>

  <script src="/js/admin/usuarios.js"></script>
</body>
</html>

    <script>
        // Gestionar Usuarios - Admin
        document.addEventListener('DOMContentLoaded', function() {
          cargarUsuarios();
          document.getElementById('userForm').addEventListener('submit', guardarUsuario);
        });

        function cargarUsuarios() {
          fetch('/admin/api/usuarios')
            .then(res => res.json())
            .then(data => {
              const tbody = document.getElementById('usuariosTable');
              tbody.innerHTML = '';
              
              if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No hay usuarios registrados</td></tr>';
                return;
              }

              data.forEach(usuario => {
                const fechaCreacion = usuario.FECHA_CREACION ? new Date(usuario.FECHA_CREACION).toLocaleDateString() : '-';
                const ultimoAcceso = usuario.ULTIMO_ACCESO ? new Date(usuario.ULTIMO_ACCESO).toLocaleDateString() : 'Nunca';

                const row = `
                  <tr>
                    <td>${usuario.ID_USUARIO}</td>
                    <td>${usuario.NOMBRE_USUARIO}</td>
                    <td>${usuario.TIPO_USUARIO}</td>
                    <td><span class="badge badge-success">${usuario.ESTADO}</span></td>
                    <td>${ultimoAcceso}</td>
                    <td>
                      <button class="btn btn-small btn-warning" onclick="abrirEditarUsuario(${usuario.ID_USUARIO}, '${usuario.NOMBRE_USUARIO}', '${usuario.TIPO_USUARIO}')">‚úèÔ∏è Editar</button>
                      <button class="btn btn-small btn-danger" onclick="eliminarUsuario(${usuario.ID_USUARIO})">üóëÔ∏è Eliminar</button>
                    </td>
                  </tr>
                `;
                tbody.innerHTML += row;
              });
            })
            .catch(err => {
              console.error('Error:', err);
              document.getElementById('usuariosTable').innerHTML = '<tr><td colspan="6" style="text-align: center; color: red;">Error al cargar usuarios</td></tr>';
            });
        }

        function guardarUsuario(event) {
          event.preventDefault();

          const nombre_usuario = document.getElementById('nombre_usuario').value;
          const contrasena = document.getElementById('contrasena').value;
          const tipo_usuario = document.getElementById('tipo_usuario').value;

          if (!nombre_usuario || !contrasena || !tipo_usuario) {
            alert('‚ö†Ô∏è Debes completar todos los campos');
            return;
          }

          fetch('/admin/api/usuarios/crear', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              nombre_usuario,
              contrasena,
              tipo_usuario
            })
          })
            .then(res => res.json())
            .then(data => {
              if (data.success) {
                alert('‚úÖ Usuario creado exitosamente');
                document.getElementById('userForm').reset();
                cargarUsuarios();
              } else {
                alert('‚ùå Error: ' + (data.error || 'Error desconocido'));
              }
            })
            .catch(err => {
              console.error('Error:', err);
              alert('‚ùå Error al crear usuario');
            });
        }

        function abrirEditarUsuario(id, nombre, tipo) {
          const nuevoNombre = prompt('Nuevo nombre de usuario:', nombre);
          if (nuevoNombre === null) return;

          const nuevoTipo = prompt('Nuevo tipo de usuario (ALUMNO/ADMIN/DOCENTE):', tipo);
          if (nuevoTipo === null) return;

          fetch(`/admin/api/usuarios/${id}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              nombre_usuario: nuevoNombre,
              tipo_usuario: nuevoTipo
            })
          })
            .then(res => res.json())
            .then(data => {
              if (data.success) {
                alert('‚úÖ Usuario editado exitosamente');
                cargarUsuarios();
              } else {
                alert('‚ùå Error: ' + (data.error || 'Error desconocido'));
              }
            })
            .catch(err => {
              console.error('Error:', err);
              alert('‚ùå Error al editar usuario');
            });
        }

        function eliminarUsuario(id) {
          if (confirm('¬øEst√°s seguro de que deseas eliminar este usuario?')) {
            fetch(`/admin/api/usuarios/${id}`, {
              method: 'DELETE',
              headers: {
                'Content-Type': 'application/json'
              }
            })
              .then(res => res.json())
              .then(data => {
                if (data.success) {
                  alert('‚úÖ Usuario eliminado exitosamente');
                  cargarUsuarios();
                } else {
                  alert('‚ùå Error: ' + (data.error || 'Error desconocido'));
                }
              })
              .catch(err => {
                console.error('Error:', err);
                alert('‚ùå Error al eliminar usuario');
              });
          }
        }

        // Estilos
        const style = document.createElement('style');
        style.textContent = `
          .badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
          }
          .badge-success {
            background: #d4edda;
            color: #155724;
          }
          .btn-small {
            padding: 4px 8px;
            font-size: 12px;
            margin-right: 5px;
          }
          .btn-warning {
            background: #ffc107;
            color: #000;
          }
          .btn-danger {
            background: #dc3545;
            color: #fff;
          }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>